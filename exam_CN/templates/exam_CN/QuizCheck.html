{% extends "global/Page.html" %}
{% load otree %}

{% block title %}
ç†è§£ç¨‹åº¦æµ‹è¯•
{% endblock %}

{% block content %}
<div class="container mt-4">
    <div class="card shadow-sm">
        <div class="card-header bg-primary text-white">
            <h4>ğŸ“˜ å®éªŒè§„åˆ™ç†è§£æµ‹è¯•</h4>
        </div>

        <div class="card-body">
            <p class="lead">
                è¯·å›ç­”ä¸‹åˆ—é—®é¢˜ï¼Œå¦‚æœå›ç­”é”™è¯¯è¯·æ ¹æ®æ­£ç¡®ç­”æ¡ˆçš„è§£è¯´é‡æ–°é€‰æ‹©æ­£ç¡®ç­”æ¡ˆã€‚
            </p>
            <hr>

            <!-- âœ… æ¯é¢˜é…ç½®ï¼šé€‰æ‹©åå³æ—¶æ˜¾ç¤ºè§£é‡Š -->
            <div class="mb-3">
                {% formfield player.q1 label="Q1. æ¯ä¸€è½®å¼€å§‹æ—¶ï¼Œä½ éƒ½ä¼šè·å¾—äººç”Ÿç§¯åˆ†ï¼Œè¿™äº›ç§¯åˆ†ä½ å¯ä»¥ç”¨äºå­¦ä¹ å’Œç”Ÿæ´»çš„èµ„æºï¼Œè€ŒèŠ±æ—¶é—´å­¦ä¹ ä¼šæ¶ˆè€—è¿™äº›ç§¯åˆ†ã€‚" %}
                <p id="exp_q1" class="text-danger small mt-1"></p>
            </div>

            <div class="mb-3">
                {% formfield player.q2 label="Q2. ä½ å­¦ä¹ çš„æ—¶é—´è¶Šé•¿ï¼Œä½ çš„å­¦ä¹ æˆç»©è¶Šé«˜ï¼Œä½†ä½ çš„äººç”Ÿç§¯åˆ†ä¼šå‡å°‘ã€‚" %}
                <p id="exp_q2" class="text-danger small mt-1"></p>
            </div>

            <div class="mb-3">
                {% formfield player.q3 label="Q3. å³ä½¿ä½ æ’åç¬¬å››ï¼Œå­¦ä¹ æˆç»©è¾ƒå·®ï¼Œä¹Ÿæœ‰å¯èƒ½è€ƒå…¥é¡¶å°–å¤§å­¦ã€‚" %}
                <p id="exp_q3" class="text-danger small mt-1"></p>
            </div>

            <div class="mb-3">
                {% formfield player.q4 label="Q4. æœ€ç»ˆæ’åæ ¹æ®æ¯ä½å­¦ç”Ÿçš„å­¦ä¹ æˆç»©ï¼ˆå­¦ä¹ æ—¶é—´ï¼‰å†³å®šã€‚" %}
                <p id="exp_q4" class="text-danger small mt-1"></p>
            </div>

            <div class="mb-3">
                {% formfield player.q5 label="Q5. å­¦ä¹ å¯ä»¥æé«˜è®°å¾—å­¦ä¹ æˆç»©ï¼Œå¹¶å¢åŠ ä½ çš„äººç”Ÿç§¯åˆ†ã€‚" %}
                <p id="exp_q5" class="text-danger small mt-1"></p>
            </div>

            <div class="mb-3">
                {% formfield player.q6 label="Q6. å¢åŠ å­¦ä¹ æ—¶é—´çš„æˆæœ¬å§‹ç»ˆæ˜¯æ’å®šçš„ï¼šä¾‹å¦‚ï¼Œä» 2 å°æ—¶å¢åŠ åˆ° 3 å°æ—¶çš„æˆæœ¬ä¸ä» 8 å°æ—¶å¢åŠ åˆ° 9 å°æ—¶çš„æˆæœ¬ç›¸åŒã€‚" %}
                <p id="exp_q6" class="text-danger small mt-1"></p>
            </div>

            <div class="mb-3">
                {% formfield player.q7 label="Q7. ç¬¬ä¸€è½®å­¦ä¹ äº†1å°æ—¶ï¼Œç¬¬äºŒè½®å­¦ä¹ äº†2å°æ—¶ï¼Œç¬¬ä¸‰è½®å­¦ä¹ äº†3å°æ—¶ï¼Œç¬¬å››è½®å­¦ä¹ äº†4å°æ—¶ï¼Œç¬¬äº”è½®å­¦ä¹ äº†5å°æ—¶ã€‚è¿™ä¸ªäººçš„å­¦ä¹ æˆç»©å¦‚ä½•ï¼Ÿ" %}
                <button type="button" id="checkQ7" class="btn btn-outline-primary btn-sm ms-2">ç¡®è®¤</button>
                <p id="exp_q7" class="text-danger small mt-1"></p>
            </div>

            <div class="text-center mt-4">
                {% next_button %}
            </div>
        </div>
    </div>
</div>

<!-- âœ… JS è„šæœ¬ï¼šé€‰æ‹©åç«‹åˆ»æ˜¾ç¤ºè§£é‡Š -->
<script>
document.addEventListener('DOMContentLoaded', () => {
    const explanations = {
        q1: "æ¯ä¸€è½®å¼€å§‹æ—¶ä½ è·å¾—çš„äººç”Ÿç§¯åˆ†ç”¨äºå­¦ä¹ çš„è¯ä¼šæ¶ˆè€—ä½ çš„äººç”Ÿç§¯åˆ†ã€‚",
        q2: "å­¦ä¹ æ—¶é—´è¶Šé•¿é«˜å­¦ä¹ æˆç»©è¶Šé«˜ï¼Œä½†æ˜¯äººç”Ÿç§¯åˆ†ä¼šå‡å°‘ã€‚",
        q3: "åªæœ‰å­¦ä¹ æˆç»©æœ€é«˜çš„ä¸€ä½å­¦ç”Ÿæ‰èƒ½è€ƒå…¥é¡¶å°–å¤§å­¦ã€‚",
        q4: "æœ€ç»ˆæ’åæ˜¯æ ¹æ®å­¦ç”Ÿçš„å­¦ä¹ æˆç»©å†³å®šã€‚",
        q5: "å­¦ä¹ ä¼šæ¶ˆè€—äººç”Ÿç§¯åˆ†",
        q6: "å­¦ä¹ æˆæœ¬ä¸æ˜¯æ’å®šçš„ï¼Œä¼šéšç€å­¦ä¹ æ—¶é—´å¢é•¿å­¦ä¹ æˆæœ¬å¢é«˜ã€‚",
        q7: "æ­£ç¡®ç­”æ¡ˆæ˜¯15 (1+2+3+4+5 = 15)ã€‚"
    };

    // æ­£ç¡®ç­”æ¡ˆå®šä¹‰
    const correct = { q1: true, q2: true, q3: false, q4: true, q5: false, q6: false, q7: 15 };

    // --- å•é€‰é¢˜å³æ—¶åˆ¤æ–­ ---
    for (const qid of ['q1', 'q2', 'q3', 'q4', 'q5', 'q6']) {
        const radios = document.querySelectorAll(`[name="${qid}"]`);
        radios.forEach(radio => {
            radio.addEventListener("change", e => {
                const val = (e.target.value === "True");
                const msgEl = document.getElementById(`exp_${qid}`);
                msgEl.textContent = (val === correct[qid]) ? "âœ… å›ç­”æ­£ç¡®ï¼" : explanations[qid];
            });
        });
    }

    // --- ç¬¬7é¢˜ï¼ˆè¾“å…¥é¢˜ï¼‰ç‚¹å‡»ç¡®è®¤æŒ‰é’®åˆ¤æ–­ ---
    const q7input = document.querySelector('input[name="q7"]');
    const q7btn = document.getElementById('checkQ7');
    q7btn.addEventListener('click', () => {
        const val = parseInt(q7input.value, 10);
        const msgEl = document.getElementById('exp_q7');
        if (isNaN(val)) {
            msgEl.textContent = "è¯·è¾“å…¥æ•°å­—ã€‚";
            return;
        }
        msgEl.textContent = (val === 15) ? "âœ… å›ç­”æ­£ç¡®ï¼" : explanations.q7;
    });

    // --- æäº¤åï¼šæŠŠåç«¯ä¼ æ¥çš„ explanations_json æ˜¾ç¤ºåœ¨å„é¢˜ä¸‹ï¼ˆé˜»æ­¢è·³é¡µæ—¶ç”¨ï¼‰ ---
    const explanationsFromServer = {{ explanations_json|safe }};
    if (explanationsFromServer && Object.keys(explanationsFromServer).length) {
        for (const [qid, msg] of Object.entries(explanationsFromServer)) {
            const el = document.getElementById(`exp_${qid}`);
            if (el) el.textContent = msg;
        }
    }

    // --- è‡ªåŠ¨æ»šåˆ°ç¬¬ä¸€ä¸ªé”™è¯¯ ---
    const firstError = document.querySelector(".text-danger.small.mt-1:not(:empty)");
    if (firstError) {
        firstError.scrollIntoView({ behavior: 'smooth', block: 'center' });
    }
});
</script>


<!-- âœ… å°† oTree çš„é»˜è®¤æ—¥è¯­æç¤ºæ›¿æ¢ä¸ºä¸­æ–‡ -->
<script>
document.addEventListener('DOMContentLoaded', function() {
    const observer = new MutationObserver(() => {
        // é€‰æ‹©æ‰€æœ‰çš„ oTree éªŒè¯æç¤ºå…ƒç´ 
        document.querySelectorAll('.otree-invalid-feedback, .invalid-feedback').forEach(el => {
            const text = el.textContent.trim();
            if (
                text.includes('ã“ã‚Œã‚‰ã®ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã®ã†ã¡') ||
                text.includes('ã„ãšã‚Œã‹ã‚’é¸æŠã—ã¦ãã ã•ã„') ||
                text.includes('Select one of the options')
            ) {
                el.textContent = 'è¯·é€‰æ‹©ä¸€ä¸ªé€‰é¡¹ã€‚';
            }
        });

        // æœ‰æ—¶æç¤ºæ–‡å­—åŒ…è£¹åœ¨ title å±æ€§é‡Œï¼ˆé¼ æ ‡æ‚¬åœæç¤ºï¼‰
        document.querySelectorAll('[title]').forEach(el => {
            const t = el.getAttribute('title');
            if (t && (t.includes('ã“ã‚Œã‚‰ã®ã‚ªãƒ—ã‚·ãƒ§ãƒ³') || t.includes('ã„ãšã‚Œã‹ã‚’é¸æŠ'))) {
                el.setAttribute('title', 'è¯·é€‰æ‹©ä¸€ä¸ªé€‰é¡¹ã€‚');
            }
        });
    });

    // ç›‘å¬æ•´ä¸ªé¡µé¢ï¼Œé˜²æ­¢ oTree åŠ¨æ€æ³¨å…¥æ—¶æ¼æ‰
    observer.observe(document.body, { childList: true, subtree: true });
});
</script>


{% endblock %}
