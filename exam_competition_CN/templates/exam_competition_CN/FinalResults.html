{% block title %}
ç»“æœ - å›åˆ {{ world_round }}/5
{% endblock %}

{% block content %}
    <p><strong>ä½ æ˜¯ <u>ç©å®¶ {{ player.id_in_group }}</u>ã€‚</strong></p>
    
    <!-- å…¬å…±ï¼šæœ¬å›åˆçš„ç»“æœ -->
    <div class="card mb-3">
        <div class="card-header">
            <h5>å›åˆ {{ world_round }} çš„ç»“æœ</h5>
        </div>
        <div class="card-body">
            <p>ä½ å½“å‰çš„äººç”Ÿç‚¹ç§¯åˆ†: {{ player.points }}</p>
            <p>ç´¯è®¡å­¦ä¹ æ—¶é—´: {{ total_hours }}</p>
        </div>
    </div>

    <!-- åˆæ ¼/ä¸åˆæ ¼ç»“æœï¼ˆç¬¬5å›åˆãƒ»ç¬¬10å›åˆï¼‰ -->
    {% if player.round_number == 5 or player.round_number == C.NUM_ROUNDS %}
    <div class="card mb-3">
        <div class="alert alert-info">
            <h3>åˆæ ¼ç»“æœ</h3>
        </div>
        <div class="card-body">
            <div class="alert alert-warning">
                <h4>ğŸ† åˆæ ¼åˆ¤å®šæ ‡å‡†</h4>
                <p>å­¦ä¹ æ—¶é—´æœ€å¤šçš„ç©å®¶å°†è€ƒä¸Šé¡¶å°–å¤§å­¦ã€‚<br>
                è‹¥å­¦ä¹ æˆç»©ç›¸åŒï¼Œå°†éšæœºå†³å®šä¸€åç©å®¶åˆæ ¼ã€‚</p>
            </div>    

            {% if winner %}
            <div class="alert alert-success">
                <h3> ğŸ“ æ­å–œä½ ï¼ä½ è€ƒä¸Šäº†é¡¶å°–å¤§å­¦ï¼</h3>
                <p>ä½ è·å¾—äº†äººç”Ÿç§¯åˆ† {{ winner_bonus }} ç‚¹å¥–åŠ±ã€‚</p>
            </div>
            {% else %}
            <div class="alert alert-info">
                <h3>å¾ˆé—æ†¾ï¼Œä½ æœªèƒ½è€ƒä¸Šé¡¶å°–å¤§å­¦ã€‚</h3>
                <p>ä½ è·å¾—äº†äººç”Ÿç§¯åˆ† {{ loser_bonus }} ç‚¹å¥–åŠ±ã€‚</p>
            </div>
            {% endif %}

            <h4>å›åˆç»“æŸæ—¶çš„ç§¯åˆ†ï¼š<strong>{{ player.points }}</strong> ç‚¹</h4>
            <h4>æœ€ç»ˆäººç”Ÿç§¯åˆ†ï¼ˆå«å¥–åŠ±ï¼‰ï¼š<strong>{{ final_points }}</strong> ç‚¹</h4>
        </div>
    </div>
    {% endif %}
    

    <!-- ä½ çš„è¡ŒåŠ¨è®°å½•ï¼ˆä»…è‡ªå·±å¯è§ï¼‰ -->
    <div class="card mb-3">
        <div class="card-header bg-info text-white">
            <h4>ä½ çš„è¡ŒåŠ¨è®°å½•</h4>
        </div>
        <div class="card-body">
            <h5 class="mt-4">å­¦ä¹ æ—¶é—´å˜åŒ–è¶‹åŠ¿</h5>
            <canvas id="effortChart" style="height:100px;"></canvas>    
            
            <!-- âœ… åªæ˜¾ç¤ºè‡ªå·±çš„å›åˆè®°å½• -->
            <table class="table table-bordered text-center align-middle mt-3">
                <thead class="table-light">
                    <tr>
                        <th>å›åˆ</th>
                        <th>å­¦ä¹ æ—¶é—´</th>
                        <th>å½“å‰äººç”Ÿç§¯åˆ†</th>
                    </tr>
                </thead>
                <tbody>
                    {% for r in history %}
                    <tr>
                        <td>{{ r.round }}</td>
                        <td>{{ r.effort }} å°æ—¶</td>
                        <td>{{ r.points }} ç§¯åˆ†</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>

    <!-- ä½ çš„è€ƒè¯•ç»“æœï¼ˆç¬¬5ãƒ»ç¬¬10å›åˆå‡æ˜¾ç¤ºï¼‰ -->
    <div class="card">
        <div class="card-header bg-primary text-white">
            <h5>ä½ çš„è€ƒè¯•ç»“æœ</h5>
        </div>
        <div class="card-body text-center">

            <!-- âœ… åªæ˜¾ç¤ºè‡ªå·±çš„æ’åã€ç‚¹æ•°ã€å¥–åŠ± -->
            <p>ğŸ“š <strong>å­¦ä¹ æˆç»©æ’åï¼š</strong> ç¬¬ {{ my_result.rank }} ä½</p>
            <p>ğŸ’° <strong>å›åˆç»“æŸæ—¶çš„äººç”Ÿç§¯åˆ†ï¼š</strong> {{ points_before_bonus }} ç‚¹</p>
            <p>ğŸ <strong>{{ bonus_text }}</strong></p>
            <hr>
            <p><strong>æœ€ç»ˆäººç”Ÿç§¯åˆ†ï¼ˆå«å¥–åŠ±ï¼‰ï¼š</strong> {{ final_points }} ç‚¹</p>
                    
            {% if my_result.winner %}
                <p class="mt-3 text-success fw-bold">ğŸ“ é¡¶å°–å¤§å­¦åˆæ ¼</p>
            {% else %}
                <p class="mt-3 text-muted">å¾ˆé—æ†¾ï¼Œä½ æœªèƒ½åˆæ ¼ã€‚</p>
            {% endif %}
        </div>
    </div>

    <!-- å”¯ä¸€çš„ Next æŒ‰é’® -->
    <div class="mt-4">
        {{ next_button }}
    </div>

    <!-- å›¾è¡¨æ•°æ® -->
    <script id="history_data" type="application/json">{{ history_json|safe }}</script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <script>
        const parsed = JSON.parse(document.getElementById('history_data').textContent);
        const series = parsed.filter(r => Number.isFinite(r.effort) && Number.isInteger(r.round));
        const effortData = parsed.map(r => r.effort);
        const roundNumbers = parsed.map(r => r.round);
    
        const ctx = document.getElementById('effortChart').getContext('2d');
        const chart = new Chart(ctx, {
            type: 'line',
            data: {
                labels: roundNumbers,
                datasets: [{
                    label: 'å­¦ä¹ æ—¶é—´ï¼ˆå°æ—¶ï¼‰',
                    data: effortData,
                    borderColor: 'rgba(54, 162, 235, 1)',
                    backgroundColor: 'rgba(54, 162, 235, 0.1)',
                    fill: true,
                    tension: 0.3,
                    pointRadius: 5,
                    pointHoverRadius: 7
                }]
            },
            options: {
                plugins: {
                    legend: {
                        labels: { font: { size: 14 } }
                    }
                },
                scales: {
                    y: {
                        beginAtZero: true,
                        ticks: { font: { size: 14 } },
                        title: { 
                            display: true,
                            text: 'å­¦ä¹ æ—¶é—´', font: { size: 14, weight: 'bold'}
                        }
                    },
                    x: {
                        ticks: { font: { size: 14 } },
                        title: {
                            display: true,
                            text: 'å›åˆ', font: { size: 16, weight: 'bold' }
                        }
                    }
                }
            }
        });
    </script>
{% endblock %}
